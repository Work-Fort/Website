[tools]
node = "latest"
python = "latest"
# AWS CLI for S3/CloudFront deployment
awscli = "latest"
# SOPS for secrets encryption (pinned for reproducibility)
"aqua:getsops/sops" = "3.11.0"
# age encryption tool (backend for SOPS, pinned for reproducibility)
"aqua:FiloSottile/age" = "1.3.1"
# yq for parsing YAML secrets
"aqua:mikefarah/yq" = "latest"

[env]
_.file = ".env.local"

[tasks.install]
description = "Install Node.js dependencies"
run = "npm ci"

[tasks.update]
description = "Update package-lock.json (use after changing package.json)"
run = "npm install"

[tasks.serve]
description = "Start Docusaurus dev server on port 8000"
run = "npm start -- --host 0.0.0.0 --port 8000"

[tasks.build]
description = "Build Docusaurus site for production"
run = "npm run build"

[tasks.aws_deploy]
description = "Build and deploy website to S3 + invalidate CloudFront cache"
run = """
npm run build
mise run aws_sync_s3
mise run aws_invalidate_cache
"""

[tasks.deploy]
depends = ["aws_deploy"]

[tasks.aws_sync_s3]
description = "Sync build/ to S3"
run = """
export AWS_ACCESS_KEY_ID=$(sops -d secrets.yaml | yq .aws_access_key_id)
export AWS_SECRET_ACCESS_KEY=$(sops -d secrets.yaml | yq .aws_secret_access_key)
export BUCKET=$(sops -d secrets.yaml | yq .s3_bucket)

aws s3 sync build/ s3://${BUCKET}/ --delete
"""

[tasks.aws_invalidate_cache]
description = "Invalidate CloudFront cache"
run = """
export AWS_ACCESS_KEY_ID=$(sops -d secrets.yaml | yq .aws_access_key_id)
export AWS_SECRET_ACCESS_KEY=$(sops -d secrets.yaml | yq .aws_secret_access_key)
export DIST_ID=$(sops -d secrets.yaml | yq .cloudfront_distribution_id)

aws cloudfront create-invalidation --distribution-id ${DIST_ID} --paths "/*"
"""

[tasks.secrets_decrypt]
description = "Decrypt secrets.yaml for viewing"
run = "sops --decrypt secrets.yaml"

[tasks.secrets_edit]
description = "Edit encrypted secrets (requires SOPS_AGE_KEY)"
run = "sops secrets.yaml"

[tasks.python-deps]
description = "Install Python dependencies for image generation"
run = "pip install --quiet openai requests"

# OpenAI DALL-E 3 image generation (with Kimi K2.5 prompt enhancement)
[tasks."openai:gen-hero"]
description = "Generate hero image with DALL-E 3 (1792x1024) - Usage: mise run openai:gen-hero -- --prompt 'text' --output 'path'"
run = """
export OPENAI_API_KEY=$(sops -d secrets.yaml | yq .openai_api_key)
export NOVITA_API_KEY=$(sops -d secrets.yaml | yq .novita_api_key)
python scripts/generate-image.py "$@" --size 1792x1024 --quality standard
"""

[tasks."openai:gen-avatar"]
description = "Generate avatar with DALL-E 3 (1024x1024, HD) - Usage: mise run openai:gen-avatar -- --prompt 'text' --output 'path'"
run = """
export OPENAI_API_KEY=$(sops -d secrets.yaml | yq .openai_api_key)
export NOVITA_API_KEY=$(sops -d secrets.yaml | yq .novita_api_key)
python scripts/generate-image.py "$@" --size 1024x1024 --quality hd
"""

[tasks."openai:gen-featured"]
description = "Generate featured image with DALL-E 3 (1024x1024) - Usage: mise run openai:gen-featured -- --prompt 'text' --output 'path'"
run = """
export OPENAI_API_KEY=$(sops -d secrets.yaml | yq .openai_api_key)
export NOVITA_API_KEY=$(sops -d secrets.yaml | yq .novita_api_key)
python scripts/generate-image.py "$@" --size 1024x1024 --quality standard
"""

# Hunyuan Image 3 (via Novita.ai)
[tasks."hunyuan:gen-hero"]
description = "Generate hero image with Hunyuan Image 3 (1536x1024) - Usage: mise run hunyuan:gen-hero -- --prompt 'text' --output 'path'"
run = """
export NOVITA_API_KEY=$(sops -d secrets.yaml | yq .novita_api_key)
python scripts/generate-image-hunyuan.py "$@" --size 1536x1024
"""

[tasks."hunyuan:gen-avatar"]
description = "Generate avatar with Hunyuan Image 3 (1024x1024) - Usage: mise run hunyuan:gen-avatar -- --prompt 'text' --output 'path'"
run = """
export NOVITA_API_KEY=$(sops -d secrets.yaml | yq .novita_api_key)
python scripts/generate-image-hunyuan.py "$@" --size 1024x1024
"""

[tasks."hunyuan:gen-featured"]
description = "Generate featured image with Hunyuan Image 3 (1024x1024) - Usage: mise run hunyuan:gen-featured -- --prompt 'text' --output 'path'"
run = """
export NOVITA_API_KEY=$(sops -d secrets.yaml | yq .novita_api_key)
python scripts/generate-image-hunyuan.py "$@" --size 1024x1024
"""

# Google Gemini 2.5 Flash Image (nano-banana) with Kimi K2.5 prompt enhancement
[tasks."nanobana:gen-hero"]
description = "Generate hero image with Gemini 2.5 Flash Image (1792x1024) - Usage: mise run nanobana:gen-hero -- --prompt 'text' --output 'path'"
run = """
export GEMINI_API_KEY=$(sops -d secrets.yaml | yq .gemini_api_key)
export NOVITA_API_KEY=$(sops -d secrets.yaml | yq .novita_api_key)
python scripts/generate-image-nanobana.py "$@" --size 1792x1024
"""

[tasks."nanobana:gen-avatar"]
description = "Generate avatar with Gemini 2.5 Flash Image (1024x1024) - Usage: mise run nanobana:gen-avatar -- --prompt 'text' --output 'path'"
run = """
export GEMINI_API_KEY=$(sops -d secrets.yaml | yq .gemini_api_key)
export NOVITA_API_KEY=$(sops -d secrets.yaml | yq .novita_api_key)
python scripts/generate-image-nanobana.py "$@" --size 1024x1024
"""

[tasks."nanobana:gen-featured"]
description = "Generate featured image with Gemini 2.5 Flash Image (1792x1024) - Usage: mise run nanobana:gen-featured -- --prompt 'text' --output 'path'"
run = """
export GEMINI_API_KEY=$(sops -d secrets.yaml | yq .gemini_api_key)
export NOVITA_API_KEY=$(sops -d secrets.yaml | yq .novita_api_key)
python scripts/generate-image-nanobana.py "$@" --size 1792x1024
"""

# Discord announcement for new blog posts
[tasks."discord:announce-blog"]
description = "Post blog announcement to Discord - Usage: mise run discord:announce-blog -- --title 'text' --url 'url' --description 'text' [--image 'url']"
run = """
export DISCORD_WEBHOOK_URL=$(sops -d secrets.yaml | yq .discord_blog_announce_webhook)

if [ -z "$DISCORD_WEBHOOK_URL" ]; then
  echo "Error: discord-blog-announce-webhook not found in secrets.yaml"
  exit 1
fi

# Parse arguments
while [ $# -gt 0 ]; do
  case "$1" in
    --title) POST_TITLE="$2"; shift 2;;
    --url) POST_URL="$2"; shift 2;;
    --description) POST_DESC="$2"; shift 2;;
    --image) POST_IMAGE="$2"; shift 2;;
    *) shift;;
  esac
done

PAYLOAD=$(jq -n \
  --arg title "$POST_TITLE" \
  --arg url "$POST_URL" \
  --arg desc "$POST_DESC" \
  --arg img "${POST_IMAGE:-}" \
  '{
    embeds: [{
      title: $title,
      url: $url,
      description: $desc,
      color: 62719,
      image: (if $img != "" then { url: $img } else null end),
      footer: { text: "workfort.dev" }
    }]
  }')

curl -sf -X POST "$DISCORD_WEBHOOK_URL" \
  -H "Content-Type: application/json" \
  -d "$PAYLOAD"

echo "Posted to Discord: $POST_TITLE"
"""
